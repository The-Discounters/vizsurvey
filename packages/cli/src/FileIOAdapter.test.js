import { ViewType, setAllPropertiesEmpty } from "@the-discounters/types";
import { initFirestore } from "@the-discounters/firebase-shared";
import {
  flattenState,
  exportParticipantsToJSON,
  exportAuditToJSON,
} from "./FileIOAdapter.js";
import {
  createQuestionNoTitrate,
  create2ndQuestionNoTitrate,
} from "@the-discounters/test-shared";

import ADMIN_CREDS from "../../../admin-credentials-dev.json" assert { type: "json" };
// this needs to match the value that is passed to firebase emulators:start --project=
const PROJECT_ID = "vizsurvey-test";

describe("Enum tests", () => {
  const result = ViewType["barchart"];
  expect(result).toBe(ViewType.barchart);
});

describe("Regular express test", () => {
  const files = [
    "answer-timestamps-1-2-1671914207718.csv",
    "answer-timestamps-1-2-1671914717290.csv",
    "answers-1-2-1671914207715.json",
    "answers-1-2-1671914207718.csv",
    "answers-1-2-1671914717289.json",
    "answers-1-2-1671914717290.csv",
    "debrief-1-2-1671914210663.json",
    "debrief-1-2-1671914720923.json",
    "debrief-timestamps-1-2-1671914210663.csv",
    "debrief-timestamps-1-2-1671914720923.csv",
    "demographics-1-2-1671914207718.csv",
    "demographics-1-2-1671914717290.csv",
    "discount-lit-survey-1-2-1671914207718.csv",
    "discount-lit-survey-1-2-1671914717290.csv",
    "feedback - 1 - 2 - 1671914210663.csv",
    "feedback-1-2-1671914720923.csv",
    "financial-lit-survey-1-2-1671914207718.csv",
    "financial-lit-survey-1-2-1671914717290.csv",
    "legal-1-2-1671914207718.csv",
    "legal-1-2-1671914717290.csv",
    "purpose-survey-1-2-1671914207718.csv",
    "purpose-survey-1-2-1671914717290.csv",
  ];
  const result = [];
  const re = new RegExp("answer-timestamps-\\d+-\\d+-\\d+\\.csv");
  files.forEach((file) => {
    if (re.test(file)) {
      result.push(file);
    }
  });
  expect(result.length).toBe(2);
});

describe("FileIOAdapter non firestore integration tests", () => {
  test("flattenState single treatment.", () => {
    const state = {
      appVersion: "1.1",
      gender: "self-describe",
      timezone: "America/New_York",
      timestamps: {
        purposeSurveyWorthQuestionsCompletedTimestamp:
          "2024-01-17T13:52:32.035-05:00",
        debriefTimeSec: 0,
        instructionsShownTimestamp: "2024-01-17T13:51:28.211-05:00",
        MCLInstructionTimeSec: [{ value: 3, treatmentId: 2 }],
        MCLInstructionCompletedTimestamp: [
          { value: "2024-01-17T13:51:33.250-05:00", treatmentId: 2 },
        ],
        demographicCompletedTimestamp: "2024-01-17T13:53:05.412-05:00",
        demographicTimeSec: 33.278,
        purposeSurveyWorthTimeSec: 6.585,
        demographicShownTimestamp: "2024-01-17T13:52:32.134-05:00",
        consentShownTimestamp: "2024-01-17T13:51:25.043-05:00",
        instructionsTimeSec: 1.405,
        debriefShownTimestamp: "2024-01-17T13:53:05.468-05:00",
        debriefCompletedTimestamp: "2024-01-17T13:53:05.468-05:00",
        instructionsCompletedTimestamp: "2024-01-17T13:51:29.616-05:00",
        financialLitSurveyQuestionsCompletedTimestamp:
          "2024-01-17T13:52:13.836-05:00",
        purposeSurveyWorthQuestionsShownTimestamp:
          "2024-01-17T13:52:25.450-05:00",
        financialLitSurveyTimeSec: 5.165,
        financialLitSurveyQuestionsShownTimestamp:
          "2024-01-17T13:52:08.671-05:00",
        purposeSurveyAwareTimeSec: 11.134,
        attentionCheckCompletedTimestamp: [],
        MCLInstructionShownTimestamp: [
          { value: "2024-01-17T13:51:29.648-05:00", treatmentId: 2 },
        ],
        purposeSurveyAwareQuestionsCompletedTimestamp:
          "2024-01-17T13:52:25.090-05:00",
        consentCompletedTimestamp: "2024-01-17T13:51:28.150-05:00",
        attentionCheckTimeSec: [],
        purposeSurveyAwareQuestionsShownTimestamp:
          "2024-01-17T13:52:13.956-05:00",
        experienceSurveyQuestionsCompletedTimestamp:
          "2024-01-17T13:52:08.551-05:00",
        experienceSurveyTimeSec: 19.199,
        attentionCheckShownTimestamp: [],
        consentTimeSec: 3.107,
        experienceSurveyQuestionsShownTimestamp:
          "2024-01-17T13:51:49.352-05:00",
      },
      questions: [
        {
          maxTime: 14,
          questionId: 1,
          leftMarginWidthIn: null,
          graphHeightIn: null,
          amountEarlier: 350,
          sequenceId: 1,
          bottomMarginHeightIn: null,
          treatmentId: 2,
          instructionGifPrefix: "introduction-barchart-no-ticks-none-right",
          screenAttributes: {
            availWidth: 1792,
            pixelDepth: 24,
            availTop: 0,
            width: 1792,
            colorDepth: 24,
            isExtended: false,
            availLeft: 0,
            availHeight: 1120,
            height: 1120,
          },
          treatmentQuestionId: 197,
          showMinorTicks: false,
          maxAmount: 430,
          widthIn: null,
          timeLater: 13,
          dateLater: null,
          amountLater: 430,
          graphWidthIn: null,
          horizontalPixels: 600,
          choiceTimestamp: "2024-01-17T13:51:35.182-05:00",
          timeEarlier: 4,
          heightIn: null,
          verticalPixels: 300,
          variableAmount: "none",
          choiceTimeSec: 1.905,
          viewType: "barchart",
          interaction: "none",
          comment: null,
          windowAttributes: {
            innerWidth: 1991,
            innerHeight: 1244,
            outerHeight: 1120,
            screenLeft: 0,
            outerWidth: 1792,
            screenTop: 0,
            devicePixelRatio: 1.7999999523162842,
          },
          choice: "earlierAmount",
          dateEarlier: null,
          shownTimestamp: "2024-01-17T13:51:33.277-05:00",
        },
        {
          maxTime: 19,
          questionId: 2,
          leftMarginWidthIn: null,
          graphHeightIn: null,
          amountEarlier: 490,
          sequenceId: 2,
          bottomMarginHeightIn: null,
          treatmentId: 2,
          instructionGifPrefix: "introduction-barchart-no-ticks-none-right",
          screenAttributes: {
            availWidth: 1792,
            pixelDepth: 24,
            availTop: 0,
            width: 1792,
            colorDepth: 24,
            isExtended: false,
            availLeft: 0,
            availHeight: 1120,
            height: 1120,
          },
          treatmentQuestionId: 198,
          showMinorTicks: false,
          maxAmount: 700,
          widthIn: null,
          timeLater: 18,
          dateLater: null,
          amountLater: 700,
          graphWidthIn: null,
          horizontalPixels: 600,
          choiceTimestamp: "2024-01-17T13:51:37.065-05:00",
          timeEarlier: 2,
          heightIn: null,
          verticalPixels: 300,
          variableAmount: "none",
          choiceTimeSec: 0.829,
          viewType: "barchart",
          interaction: "none",
          comment: null,
          windowAttributes: {
            innerWidth: 1991,
            innerHeight: 1244,
            outerHeight: 1120,
            screenLeft: 0,
            outerWidth: 1792,
            screenTop: 0,
            devicePixelRatio: 1.7999999523162842,
          },
          choice: "laterAmount",
          dateEarlier: null,
          shownTimestamp: "2024-01-17T13:51:36.236-05:00",
        },
        {
          maxTime: 25,
          questionId: 3,
          leftMarginWidthIn: null,
          graphHeightIn: null,
          amountEarlier: 720,
          sequenceId: 3,
          bottomMarginHeightIn: null,
          treatmentId: 2,
          instructionGifPrefix: "introduction-barchart-no-ticks-none-right",
          screenAttributes: {
            availWidth: 1792,
            pixelDepth: 24,
            availTop: 0,
            width: 1792,
            colorDepth: 24,
            isExtended: false,
            availLeft: 0,
            availHeight: 1120,
            height: 1120,
          },
          treatmentQuestionId: 199,
          showMinorTicks: false,
          maxAmount: 1390,
          widthIn: null,
          timeLater: 24,
          dateLater: null,
          amountLater: 1390,
          graphWidthIn: null,
          horizontalPixels: 600,
          choiceTimestamp: "2024-01-17T13:51:38.648-05:00",
          timeEarlier: 6,
          heightIn: null,
          verticalPixels: 300,
          variableAmount: "none",
          choiceTimeSec: 0.743,
          viewType: "barchart",
          interaction: "none",
          comment: null,
          windowAttributes: {
            innerWidth: 1991,
            innerHeight: 1244,
            outerHeight: 1120,
            screenLeft: 0,
            outerWidth: 1792,
            screenTop: 0,
            devicePixelRatio: 1.7999999523162842,
          },
          choice: "earlierAmount",
          dateEarlier: null,
          shownTimestamp: "2024-01-17T13:51:37.905-05:00",
        },
        {
          maxTime: 17,
          questionId: 4,
          leftMarginWidthIn: null,
          graphHeightIn: null,
          amountEarlier: 840,
          sequenceId: 4,
          bottomMarginHeightIn: null,
          treatmentId: 2,
          instructionGifPrefix: "introduction-barchart-no-ticks-none-right",
          screenAttributes: {
            availWidth: 1792,
            pixelDepth: 24,
            availTop: 0,
            width: 1792,
            colorDepth: 24,
            isExtended: false,
            availLeft: 0,
            availHeight: 1120,
            height: 1120,
          },
          treatmentQuestionId: 200,
          showMinorTicks: false,
          maxAmount: 1120,
          widthIn: null,
          timeLater: 16,
          dateLater: null,
          amountLater: 1120,
          graphWidthIn: null,
          horizontalPixels: 600,
          choiceTimestamp: "2024-01-17T13:51:40.150-05:00",
          timeEarlier: 3,
          heightIn: null,
          verticalPixels: 300,
          variableAmount: "none",
          choiceTimeSec: 0.73,
          viewType: "barchart",
          interaction: "none",
          comment: null,
          windowAttributes: {
            innerWidth: 1991,
            innerHeight: 1244,
            outerHeight: 1120,
            screenLeft: 0,
            outerWidth: 1792,
            screenTop: 0,
            devicePixelRatio: 1.7999999523162842,
          },
          choice: "laterAmount",
          dateEarlier: null,
          shownTimestamp: "2024-01-17T13:51:39.420-05:00",
        },
        {
          maxTime: 14,
          questionId: 5,
          leftMarginWidthIn: null,
          graphHeightIn: null,
          amountEarlier: 32,
          sequenceId: 5,
          bottomMarginHeightIn: null,
          treatmentId: 2,
          instructionGifPrefix: "introduction-barchart-no-ticks-none-right",
          screenAttributes: {
            availWidth: 1792,
            pixelDepth: 24,
            availTop: 0,
            width: 1792,
            colorDepth: 24,
            isExtended: false,
            availLeft: 0,
            availHeight: 1120,
            height: 1120,
          },
          treatmentQuestionId: 201,
          showMinorTicks: false,
          maxAmount: 40,
          widthIn: null,
          timeLater: 13,
          dateLater: null,
          amountLater: 39,
          graphWidthIn: null,
          horizontalPixels: 600,
          choiceTimestamp: "2024-01-17T13:51:41.732-05:00",
          timeEarlier: 4,
          heightIn: null,
          verticalPixels: 300,
          variableAmount: "none",
          choiceTimeSec: 0.794,
          viewType: "barchart",
          interaction: "none",
          comment: null,
          windowAttributes: {
            innerWidth: 1991,
            innerHeight: 1244,
            outerHeight: 1120,
            screenLeft: 0,
            outerWidth: 1792,
            screenTop: 0,
            devicePixelRatio: 1.7999999523162842,
          },
          choice: "earlierAmount",
          dateEarlier: null,
          shownTimestamp: "2024-01-17T13:51:40.938-05:00",
        },
        {
          maxTime: 19,
          questionId: 6,
          leftMarginWidthIn: null,
          graphHeightIn: null,
          amountEarlier: 45,
          sequenceId: 6,
          bottomMarginHeightIn: null,
          treatmentId: 2,
          instructionGifPrefix: "introduction-barchart-no-ticks-none-right",
          screenAttributes: {
            availWidth: 1792,
            pixelDepth: 24,
            availTop: 0,
            width: 1792,
            colorDepth: 24,
            isExtended: false,
            availLeft: 0,
            availHeight: 1120,
            height: 1120,
          },
          treatmentQuestionId: 202,
          showMinorTicks: false,
          maxAmount: 70,
          widthIn: null,
          timeLater: 18,
          dateLater: null,
          amountLater: 70,
          graphWidthIn: null,
          horizontalPixels: 600,
          choiceTimestamp: "2024-01-17T13:51:43.615-05:00",
          timeEarlier: 2,
          heightIn: null,
          verticalPixels: 300,
          variableAmount: "none",
          choiceTimeSec: 1.178,
          viewType: "barchart",
          interaction: "none",
          comment: null,
          windowAttributes: {
            innerWidth: 1991,
            innerHeight: 1244,
            outerHeight: 1120,
            screenLeft: 0,
            outerWidth: 1792,
            screenTop: 0,
            devicePixelRatio: 1.7999999523162842,
          },
          choice: "laterAmount",
          dateEarlier: null,
          shownTimestamp: "2024-01-17T13:51:42.437-05:00",
        },
        {
          maxTime: 25,
          questionId: 7,
          leftMarginWidthIn: null,
          graphHeightIn: null,
          amountEarlier: 66,
          sequenceId: 7,
          bottomMarginHeightIn: null,
          treatmentId: 2,
          instructionGifPrefix: "introduction-barchart-no-ticks-none-right",
          screenAttributes: {
            availWidth: 1792,
            pixelDepth: 24,
            availTop: 0,
            width: 1792,
            colorDepth: 24,
            isExtended: false,
            availLeft: 0,
            availHeight: 1120,
            height: 1120,
          },
          treatmentQuestionId: 203,
          showMinorTicks: false,
          maxAmount: 110,
          widthIn: null,
          timeLater: 24,
          dateLater: null,
          amountLater: 110,
          graphWidthIn: null,
          horizontalPixels: 600,
          choiceTimestamp: "2024-01-17T13:51:46.553-05:00",
          timeEarlier: 6,
          heightIn: null,
          verticalPixels: 300,
          variableAmount: "none",
          choiceTimeSec: 1.979,
          viewType: "barchart",
          interaction: "none",
          comment: null,
          windowAttributes: {
            innerWidth: 1991,
            innerHeight: 1244,
            outerHeight: 1120,
            screenLeft: 0,
            outerWidth: 1792,
            screenTop: 0,
            devicePixelRatio: 1.7999999523162842,
          },
          choice: "earlierAmount",
          dateEarlier: null,
          shownTimestamp: "2024-01-17T13:51:44.574-05:00",
        },
        {
          maxTime: 17,
          questionId: 8,
          leftMarginWidthIn: null,
          graphHeightIn: null,
          amountEarlier: 77,
          sequenceId: 8,
          bottomMarginHeightIn: null,
          treatmentId: 2,
          instructionGifPrefix: "introduction-barchart-no-ticks-none-right",
          screenAttributes: {
            availWidth: 1792,
            pixelDepth: 24,
            availTop: 0,
            width: 1792,
            colorDepth: 24,
            isExtended: false,
            availLeft: 0,
            availHeight: 1120,
            height: 1120,
          },
          treatmentQuestionId: 204,
          showMinorTicks: false,
          maxAmount: 120,
          widthIn: null,
          timeLater: 16,
          dateLater: null,
          amountLater: 118,
          graphWidthIn: null,
          horizontalPixels: 600,
          choiceTimestamp: "2024-01-17T13:51:48.319-05:00",
          timeEarlier: 3,
          heightIn: null,
          verticalPixels: 300,
          variableAmount: "none",
          choiceTimeSec: 0.929,
          viewType: "barchart",
          interaction: "none",
          comment: null,
          windowAttributes: {
            innerWidth: 1991,
            innerHeight: 1244,
            outerHeight: 1120,
            screenLeft: 0,
            outerWidth: 1792,
            screenTop: 0,
            devicePixelRatio: 1.7999999523162842,
          },
          choice: "laterAmount",
          dateEarlier: null,
          shownTimestamp: "2024-01-17T13:51:47.390-05:00",
        },
      ],
      countryOfResidence: "usa",
      error: null,
      selfDescribeGender: "Self Describe Gender",
      participantId: "563268",
      feedback: "Feedback",
      selfDescribeEmployment: "Self Describe Employment",
      financialLitSurvey: {
        financial_lit_survey_risk: "dont-know",
        financial_lit_survey_numeracy: "gt102",
        financial_lit_survey_inflation: "exactly-same",
      },
      browserTimestamp: "2024-01-17T13:53:10.422-05:00",
      profession: "Profession",
      serverTimestamp: { _seconds: 1705517590, _nanoseconds: 588000000 },
      consentChecked: true,
      userAgent:
        "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36",
      sessionId: "3",
      employment: "self-describe",
      instructionTreatment: [
        {
          maxTime: 8,
          questionId: 9,
          leftMarginWidthIn: null,
          graphHeightIn: null,
          amountEarlier: 300,
          instructionQuestion: true,
          sequenceId: 1,
          bottomMarginHeightIn: null,
          treatmentId: 2,
          instructionGifPrefix: "introduction-barchart-no-ticks-none-right",
          path: "experiments/D0nfaTpO1AwnDYHGtNun/treatmentQuestions/hcJsV3HtGXwSgKyXxJC0",
          treatmentQuestionId: 205,
          showMinorTicks: false,
          experimentId: 6,
          questionComment: "Instruction question",
          treatmentComment: "Barchart half screen and no minor ticks.",
          maxAmount: 1000,
          instructionQuestionId: "18",
          widthIn: null,
          timeLater: 7,
          dateLater: null,
          amountLater: 700,
          graphWidthIn: null,
          horizontalPixels: 600,
          heightIn: null,
          timeEarlier: 2,
          verticalPixels: 300,
          variableAmount: "none",
          viewType: "barchart",
          interaction: "none",
          dateEarlier: null,
        },
      ],
      vizFamiliarity: "6",
      currentAnswerIdx: 7,
      purposeSurvey: {
        purpose_survey_worth_doneall: "somewhat-disagree",
        purpose_survey_aware_certain: "disagree",
        purpose_survey_aware_describe: "somewhat-disagree",
        purpose_survey_aware_confident: "neither-agree-nor-disagree",
        purpose_survey_aware_understand: "agree",
        purpose_survey_worth_dayatatime: "disagree",
        purpose_survey_aware_clear: "strongly-disagree",
        purpose_survey_worth_wander: "strongly-disagree",
      },
      experienceSurvey: {
        experience_survey_easy: "quite-a-bit",
        experience_survey_mental: "not-at-all",
        experience_survey_understand: "a-little",
        experience_survey_imagine: "to-some-extent",
        experience_survey_clear: "very-slightly",
        experience_survey_enjoy: "not-at-all",
        experience_survey_present: "moderately",
        experience_survey_format: "extremely",
      },
      studyId: "testbetween",
      attentionCheck: [],
      age: "55",
      status: "debrief",
    };
    const result = flattenState(state);
    expect(JSON.stringify(result)).toBe(
      '{"appVersion":"1.1","gender":"self-describe","timezone":"America/New_York","purposeSurveyWorthQuestionsCompletedTimestamp":"2024-01-17T13:52:32.035-05:00","debriefTimeSec":0,"instructionsShownTimestamp":"2024-01-17T13:51:28.211-05:00","demographicCompletedTimestamp":"2024-01-17T13:53:05.412-05:00","demographicTimeSec":33.278,"purposeSurveyWorthTimeSec":6.585,"demographicShownTimestamp":"2024-01-17T13:52:32.134-05:00","consentShownTimestamp":"2024-01-17T13:51:25.043-05:00","instructionsTimeSec":1.405,"debriefShownTimestamp":"2024-01-17T13:53:05.468-05:00","debriefCompletedTimestamp":"2024-01-17T13:53:05.468-05:00","instructionsCompletedTimestamp":"2024-01-17T13:51:29.616-05:00","financialLitSurveyQuestionsCompletedTimestamp":"2024-01-17T13:52:13.836-05:00","purposeSurveyWorthQuestionsShownTimestamp":"2024-01-17T13:52:25.450-05:00","financialLitSurveyTimeSec":5.165,"financialLitSurveyQuestionsShownTimestamp":"2024-01-17T13:52:08.671-05:00","purposeSurveyAwareTimeSec":11.134,"purposeSurveyAwareQuestionsCompletedTimestamp":"2024-01-17T13:52:25.090-05:00","consentCompletedTimestamp":"2024-01-17T13:51:28.150-05:00","purposeSurveyAwareQuestionsShownTimestamp":"2024-01-17T13:52:13.956-05:00","experienceSurveyQuestionsCompletedTimestamp":"2024-01-17T13:52:08.551-05:00","experienceSurveyTimeSec":19.199,"consentTimeSec":3.107,"experienceSurveyQuestionsShownTimestamp":"2024-01-17T13:51:49.352-05:00","MCLInstructionCompletedTimestamp_2":"2024-01-17T13:51:33.250-05:00","MCLInstructionShownTimestamp_2":"2024-01-17T13:51:29.648-05:00","MCLInstructionTimeSec_2":3,"maxTime_2_1":14,"questionId_2_1":1,"leftMarginWidthIn_2_1":null,"graphHeightIn_2_1":null,"amountEarlier_2_1":350,"sequenceId_2_1":1,"bottomMarginHeightIn_2_1":null,"treatmentId_2_1":2,"instructionGifPrefix_2_1":"introduction-barchart-no-ticks-none-right","treatmentQuestionId_2_1":197,"showMinorTicks_2_1":false,"maxAmount_2_1":430,"widthIn_2_1":null,"timeLater_2_1":13,"dateLater_2_1":null,"amountLater_2_1":430,"graphWidthIn_2_1":null,"horizontalPixels_2_1":600,"choiceTimestamp_2_1":"2024-01-17T13:51:35.182-05:00","timeEarlier_2_1":4,"heightIn_2_1":null,"verticalPixels_2_1":300,"variableAmount_2_1":"none","choiceTimeSec_2_1":1.905,"viewType_2_1":"barchart","interaction_2_1":"none","comment_2_1":null,"choice_2_1":"earlierAmount","dateEarlier_2_1":null,"shownTimestamp_2_1":"2024-01-17T13:51:33.277-05:00","maxTime_2_2":19,"questionId_2_2":2,"leftMarginWidthIn_2_2":null,"graphHeightIn_2_2":null,"amountEarlier_2_2":490,"sequenceId_2_2":2,"bottomMarginHeightIn_2_2":null,"treatmentId_2_2":2,"instructionGifPrefix_2_2":"introduction-barchart-no-ticks-none-right","treatmentQuestionId_2_2":198,"showMinorTicks_2_2":false,"maxAmount_2_2":700,"widthIn_2_2":null,"timeLater_2_2":18,"dateLater_2_2":null,"amountLater_2_2":700,"graphWidthIn_2_2":null,"horizontalPixels_2_2":600,"choiceTimestamp_2_2":"2024-01-17T13:51:37.065-05:00","timeEarlier_2_2":2,"heightIn_2_2":null,"verticalPixels_2_2":300,"variableAmount_2_2":"none","choiceTimeSec_2_2":0.829,"viewType_2_2":"barchart","interaction_2_2":"none","comment_2_2":null,"choice_2_2":"laterAmount","dateEarlier_2_2":null,"shownTimestamp_2_2":"2024-01-17T13:51:36.236-05:00","maxTime_2_3":25,"questionId_2_3":3,"leftMarginWidthIn_2_3":null,"graphHeightIn_2_3":null,"amountEarlier_2_3":720,"sequenceId_2_3":3,"bottomMarginHeightIn_2_3":null,"treatmentId_2_3":2,"instructionGifPrefix_2_3":"introduction-barchart-no-ticks-none-right","treatmentQuestionId_2_3":199,"showMinorTicks_2_3":false,"maxAmount_2_3":1390,"widthIn_2_3":null,"timeLater_2_3":24,"dateLater_2_3":null,"amountLater_2_3":1390,"graphWidthIn_2_3":null,"horizontalPixels_2_3":600,"choiceTimestamp_2_3":"2024-01-17T13:51:38.648-05:00","timeEarlier_2_3":6,"heightIn_2_3":null,"verticalPixels_2_3":300,"variableAmount_2_3":"none","choiceTimeSec_2_3":0.743,"viewType_2_3":"barchart","interaction_2_3":"none","comment_2_3":null,"choice_2_3":"earlierAmount","dateEarlier_2_3":null,"shownTimestamp_2_3":"2024-01-17T13:51:37.905-05:00","maxTime_2_4":17,"questionId_2_4":4,"leftMarginWidthIn_2_4":null,"graphHeightIn_2_4":null,"amountEarlier_2_4":840,"sequenceId_2_4":4,"bottomMarginHeightIn_2_4":null,"treatmentId_2_4":2,"instructionGifPrefix_2_4":"introduction-barchart-no-ticks-none-right","treatmentQuestionId_2_4":200,"showMinorTicks_2_4":false,"maxAmount_2_4":1120,"widthIn_2_4":null,"timeLater_2_4":16,"dateLater_2_4":null,"amountLater_2_4":1120,"graphWidthIn_2_4":null,"horizontalPixels_2_4":600,"choiceTimestamp_2_4":"2024-01-17T13:51:40.150-05:00","timeEarlier_2_4":3,"heightIn_2_4":null,"verticalPixels_2_4":300,"variableAmount_2_4":"none","choiceTimeSec_2_4":0.73,"viewType_2_4":"barchart","interaction_2_4":"none","comment_2_4":null,"choice_2_4":"laterAmount","dateEarlier_2_4":null,"shownTimestamp_2_4":"2024-01-17T13:51:39.420-05:00","maxTime_2_5":14,"questionId_2_5":5,"leftMarginWidthIn_2_5":null,"graphHeightIn_2_5":null,"amountEarlier_2_5":32,"sequenceId_2_5":5,"bottomMarginHeightIn_2_5":null,"treatmentId_2_5":2,"instructionGifPrefix_2_5":"introduction-barchart-no-ticks-none-right","treatmentQuestionId_2_5":201,"showMinorTicks_2_5":false,"maxAmount_2_5":40,"widthIn_2_5":null,"timeLater_2_5":13,"dateLater_2_5":null,"amountLater_2_5":39,"graphWidthIn_2_5":null,"horizontalPixels_2_5":600,"choiceTimestamp_2_5":"2024-01-17T13:51:41.732-05:00","timeEarlier_2_5":4,"heightIn_2_5":null,"verticalPixels_2_5":300,"variableAmount_2_5":"none","choiceTimeSec_2_5":0.794,"viewType_2_5":"barchart","interaction_2_5":"none","comment_2_5":null,"choice_2_5":"earlierAmount","dateEarlier_2_5":null,"shownTimestamp_2_5":"2024-01-17T13:51:40.938-05:00","maxTime_2_6":19,"questionId_2_6":6,"leftMarginWidthIn_2_6":null,"graphHeightIn_2_6":null,"amountEarlier_2_6":45,"sequenceId_2_6":6,"bottomMarginHeightIn_2_6":null,"treatmentId_2_6":2,"instructionGifPrefix_2_6":"introduction-barchart-no-ticks-none-right","treatmentQuestionId_2_6":202,"showMinorTicks_2_6":false,"maxAmount_2_6":70,"widthIn_2_6":null,"timeLater_2_6":18,"dateLater_2_6":null,"amountLater_2_6":70,"graphWidthIn_2_6":null,"horizontalPixels_2_6":600,"choiceTimestamp_2_6":"2024-01-17T13:51:43.615-05:00","timeEarlier_2_6":2,"heightIn_2_6":null,"verticalPixels_2_6":300,"variableAmount_2_6":"none","choiceTimeSec_2_6":1.178,"viewType_2_6":"barchart","interaction_2_6":"none","comment_2_6":null,"choice_2_6":"laterAmount","dateEarlier_2_6":null,"shownTimestamp_2_6":"2024-01-17T13:51:42.437-05:00","maxTime_2_7":25,"questionId_2_7":7,"leftMarginWidthIn_2_7":null,"graphHeightIn_2_7":null,"amountEarlier_2_7":66,"sequenceId_2_7":7,"bottomMarginHeightIn_2_7":null,"treatmentId_2_7":2,"instructionGifPrefix_2_7":"introduction-barchart-no-ticks-none-right","treatmentQuestionId_2_7":203,"showMinorTicks_2_7":false,"maxAmount_2_7":110,"widthIn_2_7":null,"timeLater_2_7":24,"dateLater_2_7":null,"amountLater_2_7":110,"graphWidthIn_2_7":null,"horizontalPixels_2_7":600,"choiceTimestamp_2_7":"2024-01-17T13:51:46.553-05:00","timeEarlier_2_7":6,"heightIn_2_7":null,"verticalPixels_2_7":300,"variableAmount_2_7":"none","choiceTimeSec_2_7":1.979,"viewType_2_7":"barchart","interaction_2_7":"none","comment_2_7":null,"choice_2_7":"earlierAmount","dateEarlier_2_7":null,"shownTimestamp_2_7":"2024-01-17T13:51:44.574-05:00","maxTime_2_8":17,"questionId_2_8":8,"leftMarginWidthIn_2_8":null,"graphHeightIn_2_8":null,"amountEarlier_2_8":77,"sequenceId_2_8":8,"bottomMarginHeightIn_2_8":null,"treatmentId_2_8":2,"instructionGifPrefix_2_8":"introduction-barchart-no-ticks-none-right","treatmentQuestionId_2_8":204,"showMinorTicks_2_8":false,"maxAmount_2_8":120,"widthIn_2_8":null,"timeLater_2_8":16,"dateLater_2_8":null,"amountLater_2_8":118,"graphWidthIn_2_8":null,"horizontalPixels_2_8":600,"choiceTimestamp_2_8":"2024-01-17T13:51:48.319-05:00","timeEarlier_2_8":3,"heightIn_2_8":null,"verticalPixels_2_8":300,"variableAmount_2_8":"none","choiceTimeSec_2_8":0.929,"viewType_2_8":"barchart","interaction_2_8":"none","comment_2_8":null,"choice_2_8":"laterAmount","dateEarlier_2_8":null,"shownTimestamp_2_8":"2024-01-17T13:51:47.390-05:00","countryOfResidence":"usa","error":null,"selfDescribeGender":"Self Describe Gender","participantId":"563268","feedback":"Feedback","selfDescribeEmployment":"Self Describe Employment","financial_lit_survey_risk":"dont-know","financial_lit_survey_numeracy":"gt102","financial_lit_survey_inflation":"exactly-same","browserTimestamp":"2024-01-17T13:53:10.422-05:00","profession":"Profession","serverTimestamp":{"_seconds":1705517590,"_nanoseconds":588000000},"consentChecked":true,"userAgent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36","sessionId":"3","employment":"self-describe","vizFamiliarity":"6","currentAnswerIdx":7,"purpose_survey_worth_doneall":"somewhat-disagree","purpose_survey_aware_certain":"disagree","purpose_survey_aware_describe":"somewhat-disagree","purpose_survey_aware_confident":"neither-agree-nor-disagree","purpose_survey_aware_understand":"agree","purpose_survey_worth_dayatatime":"disagree","purpose_survey_aware_clear":"strongly-disagree","purpose_survey_worth_wander":"strongly-disagree","experience_survey_easy":"quite-a-bit","experience_survey_mental":"not-at-all","experience_survey_understand":"a-little","experience_survey_imagine":"to-some-extent","experience_survey_clear":"very-slightly","experience_survey_enjoy":"not-at-all","experience_survey_present":"moderately","experience_survey_format":"extremely","studyId":"testbetween","attentionCheck":[],"age":"55","status":"debrief"}'
    );
  });
});

describe("FileIOAdapter firestore integration tests", () => {
  let app, db;

  beforeAll(() => {
    const result = initFirestore(
      PROJECT_ID,
      "https://vizsurvey-test.firebaseio.com/",
      ADMIN_CREDS
    );
    app = result.app;
    db = result.db;
  });

  test("exportParticipantsToJSON test", async () => {
    const json = await exportParticipantsToJSON(db, "testbetween");
    expect(json).not.toBeNull();
    const parsed = JSON.parse(json);
    expect(parsed).not.toBeNull();
    expect(parsed.prolificStudyId).toBe("testbetween");
  });

  test("exportAuditToJSON test", async () => {
    const json = await exportAuditToJSON(db, "testbetween");
    expect(json).not.toBeNull();
    const parsed = JSON.parse(json);
    expect(parsed).not.toBeNull();
    expect(parsed.prolificStudyId).toBe("testbetween");
  });
});
